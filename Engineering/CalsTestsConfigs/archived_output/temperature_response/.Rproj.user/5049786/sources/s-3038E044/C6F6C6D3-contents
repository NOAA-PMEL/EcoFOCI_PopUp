require("gganimate")
require("ggplot2")
require("mapdata")
require("rerddap")
require("rerddapXtracto")
require("oce")
require("png")
require("gifski")


tagData <- Marlintag38606
xpos <- tagData$lon
ypos <- tagData$lat
tpos <- tagData$date
zpos <- xpos*0.
urlbase <- 'http://upwell.pfeg.noaa.gov/erddap'
swchlInfo <- rerddap::info('erdSWchla8day')
swchl <- rxtracto(swchlInfo, parameter = 'chlorophyll', 
                  xcoord = xpos, ycoord = ypos, tcoord = tpos, zcoord = zpos, 
                  xlen = .2, ylen = .2)

alldata <- cbind(tagData, unclass(swchl))
names(alldata)[11] <- 'time'
alldata$lon <- alldata$lon - 360

# Create a variable that shows if chla is missing
alldata$missing <- is.na(alldata$'mean chlorophyll') * 1
alldata$mean <- as.array(alldata$'mean chlorophyll')
# set limits of the map
ylim <- c(15, 30)
xlim <- c(-160, -105)
myColor <- colors$cdom
# get outline data for map
w <- map_data("worldHires", ylim = ylim, xlim = xlim)
# plot using ggplot
z <- ggplot(alldata,aes(x = lon, y = lat)) +
  geom_point(aes(colour = mean, shape = factor(missing)), size = 2.) +
  scale_shape_manual(values = c(19, 1))
z <- z + geom_polygon(data = w, aes(x = long, y = lat, group = group), fill = "grey80") +
  theme_bw() +
  scale_colour_gradientn(colours = myColor,limits = c(0., 0.32), "Chla") +
  coord_fixed(1.3, xlim = xlim, ylim = ylim) +
  transition_manual(time, cumulative = TRUE) + labs(title = "{current_frame}")
animate(z)

